# DESIGN: Модуль ППМ (План Производства на Месяц)

## 📋 ОБЗОР

**ProductDB** - ERP система для производства огнеупорных изделий.

**Модуль ППМ** - система планирования производства с:
- Созданием планов на месяц с версионированием
- Расчетом потребности в материалах и комплектующих
- Расчетом затрат
- Экспортом отчетов в Excel

---

## 🗄️ СТРУКТУРА БАЗЫ ДАННЫХ

### Таблица: production_plans (Планы производства)

**Назначение:** Хранение заголовков планов производства с версиями

```sql
CREATE TABLE production_plans (
    id INTEGER PRIMARY KEY,
    month INTEGER NOT NULL,           -- Месяц (1-12)
    year INTEGER NOT NULL,            -- Год (2025...)
    version INTEGER NOT NULL,         -- Номер версии (1, 2, 3...)
    version_date DATE NOT NULL,       -- Дата создания версии
    notes TEXT,                       -- Примечания к плану
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    UNIQUE(month, year, version)      -- Уникальность по месяц+год+версия
);
```

**Ключевые моменты:**
- Один план = один месяц (например, Ноябрь 2025)
- Может быть несколько версий одного плана (версия 1, 2, 3...)
- Последняя версия = актуальная, остальные = архивные
- Пользователь может создать "новый план" или "изменение к плану"

**Примеры:**
- План: Ноябрь 2025, версия 1, дата 01.11.2025
- План: Ноябрь 2025, версия 2, дата 03.11.2025 (изменение)
- План: Ноябрь 2025, версия 3, дата 06.11.2025 (окончательная)

---

### Таблица: production_plan_items (Позиции плана)

**Назначение:** Хранение позиций (строк) в плане производства

```sql
CREATE TABLE production_plan_items (
    id INTEGER PRIMARY KEY,
    plan_id INTEGER NOT NULL,         -- Ссылка на production_plans
    product_id INTEGER NOT NULL,      -- Ссылка на products (изделие)
    quantity_was INTEGER DEFAULT 0,   -- Было (количество)
    quantity_now INTEGER NOT NULL,    -- Стало (количество)
    deadline_was DATE,                -- Срок был
    deadline_now DATE NOT NULL,       -- Срок стал
    notes TEXT,                       -- Примечания
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    FOREIGN KEY (plan_id) REFERENCES production_plans(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

**Ключевые моменты:**
- Каждая позиция = одно изделие для одного заказчика
- Поля "было/стало" для отслеживания изменений между версиями
- Если "было" = 0, значит это новый заказ
- Если "стало" = 0, значит заказ отменен

**Примеры позиций:**
```
Версия 1:
- PB 35.126 R2-B15-НТ | было: 0 | стало: 100 | срок: 30.11.2025
- SB 651-B2-ЗС        | было: 0 | стало: 50  | срок: 25.11.2025

Версия 2 (изменение):
- PB 35.126 R2-B15-НТ | было: 100 | стало: 150 | срок было: 30.11 | срок стало: 25.11
- SB 651-B2-ЗС        | было: 50  | стало: 50  | срок: 25.11.2025 (не менялось)
- PBS 15.126R-B1-КО   | было: 0   | стало: 30  | срок: 20.11.2025 (новый заказ)
```

---

### Таблица: component_prices (Цены на комплектующие)

**Назначение:** Хранение истории цен на комплектующие

```sql
CREATE TABLE component_prices (
    id INTEGER PRIMARY KEY,
    component_id INTEGER NOT NULL,    -- Ссылка на components
    price REAL NOT NULL,              -- Цена за единицу
    currency TEXT DEFAULT 'RUB',      -- Валюта
    valid_from DATE NOT NULL,         -- С какой даты действует
    notes TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,

    FOREIGN KEY (component_id) REFERENCES components(id)
);
```

**Ключевые моменты:**
- История цен - при обновлении добавляется новая запись, старые сохраняются
- Для расчетов берется последняя цена по дате (ORDER BY valid_from DESC LIMIT 1)
- Импорт цен от снабженца через Excel/JSON файл (описание формата в README)

---

## 🧮 ЛОГИКА РАСЧЕТОВ

### Расчет потребности в материалах

**Алгоритм:**

1. **Получить актуальный план:**
   - Выбрать план по месяцу/году
   - Взять последнюю версию (MAX(version))

2. **Для каждой позиции плана:**
   - Взять изделие (product_id)
   - Получить его комплектацию из таблицы product_composition
   - Умножить количество каждого комплектующего на quantity_now

3. **Суммировать одинаковые комплектующие:**
   - Обечайка 126: (100 × 1) + (30 × 1) = 130 шт
   - Патрубок 300: (100 × 4) + (30 × 2) = 460 шт

4. **Рассчитать вес бетона:**
   - Для каждого изделия получить марку бетона из комплектации
   - Получить вес пробки + блока из таблицы weights
   - Умножить на quantity_now
   - Суммировать по маркам бетона ОТДЕЛЬНО

**Важно:** Считаем только по полю "стало" (quantity_now), поле "было" только для истории!

**Пример расчета:**

План на ноябрь, актуальная версия:
```
1. PB 35.126 R2-B15-НТ - 100 шт
2. PBS 15.126R-B1-КО  - 30 шт
```

Комплектация PB 35.126:
```
- Обечайка 126: 1 шт
- Донышко 186: 1 шт
- Патрубок 300 22 Р: 4 шт
- Бетон BaltCast 92Z (вес пробки 22 кг + блока 23 кг = 45 кг)
```

Комплектация PBS 15.126R:
```
- Обечайка 126: 1 шт
- Патрубок 250: 2 шт
- Бетон BaltCast 97NG (вес: 50 кг)
```

**Результат расчета потребности:**
```
Обечайка 126:         100 + 30 = 130 шт
Донышко 186:          100 шт
Патрубок 300 22 Р:    100 × 4 = 400 шт
Патрубок 250:         30 × 2 = 60 шт
Бетон BaltCast 92Z:   100 × 45 кг = 4500 кг (4.5 т)
Бетон BaltCast 97NG:  30 × 50 кг = 1500 кг (1.5 т)
```

---

### Расчет затрат

**Алгоритм:**

1. Взять результат расчета потребности
2. Для каждого комплектующего получить актуальную цену:
   ```sql
   SELECT price FROM component_prices
   WHERE component_id = ?
   ORDER BY valid_from DESC
   LIMIT 1
   ```
3. Умножить количество на цену
4. Суммировать

**Пример:**
```
Обечайка 126:      130 шт × 5000₽ = 650,000₽
Донышко 186:       100 шт × 3000₽ = 300,000₽
Патрубок 300 22 Р: 400 шт × 1500₽ = 600,000₽
Бетон BaltCast 92Z: 4.5 т × 50000₽/т = 225,000₽

ИТОГО: 1,775,000₽
```

---

## 📊 ОТЧЕТЫ

### 1. Отчет для снабженца

**Назначение:** Показать что нужно закупить для производства

**Формат:** Excel таблица

**Содержание:**
```
┌────────────────────┬──────────┬──────────┬────────────┐
│ Комплектующее      │ Нужно    │ Цена     │ Сумма      │
├────────────────────┼──────────┼──────────┼────────────┤
│ Обечайка 126       │ 130 шт   │ 5000₽    │ 650,000₽   │
│ Донышко 186        │ 100 шт   │ 3000₽    │ 300,000₽   │
│ Патрубок 300 22 Р  │ 400 шт   │ 1500₽    │ 600,000₽   │
│ Бетон BaltCast 92Z │ 4.5 т    │ 50000₽/т │ 225,000₽   │
│ Бетон BaltCast 97NG│ 1.5 т    │ 55000₽/т │ 82,500₽    │
├────────────────────┴──────────┴──────────┼────────────┤
│                            ИТОГО:        │ 1,857,500₽ │
└──────────────────────────────────────────┴────────────┘
```

**Сортировка:** По типу комплектующих (Обечайки, Донышки, Патрубки, Бетон...)

**Название файла:** `Потребность_материалы_YYYY-MM.xlsx` (например `Потребность_материалы_2025-11.xlsx`)

**Папка сохранения:** `reports/supply/`

**Цены:** Опционально (можно включить/выключить)

---

### 2. ППМ для директора (для подписи)

**Назначение:** Официальный документ плана производства для утверждения

**Формат:** Заполнение Excel шаблона

**Содержание:**
```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  ПЛАН ПРОИЗВОДСТВА НА МЕСЯЦ                    ┃
┃  Ноябрь 2025 (версия 3)                        ┃
┃                                                 ┃
┃  Директор: _____________ /Иванов И.И./         ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┌────┬──────────┬─────────────────┬──────┬────────┬──────────┬──────────┬────────┐
│ №  │ Заказчик │ Чертеж          │ Наим.│ Было   │ Стало    │ Срок     │ Прим.  │
├────┼──────────┼─────────────────┼──────┼────────┼──────────┼──────────┼────────┤
│ 1  │ НТ       │ PB 35.126 R2... │ Блок │ 100 шт │ 150 шт   │30.11.2025│ Срочно │
│ 2  │ ЗС       │ SB 651-B2-ЗС    │ Шиб. │ 50 шт  │ 50 шт    │25.11.2025│        │
│ 3  │ КО       │ PBS 15.126R...  │ Блок │ 0 шт   │ 30 шт    │20.11.2025│ Новый  │
└────┴──────────┴─────────────────┴──────┴────────┴──────────┴──────────┴────────┘

Примечания:
___________________________________________________________________________

НОС: ____________   НОП: ____________   ЗД: ____________
```

**Логика заполнения:**
- Используется готовый Excel шаблон: `templates/PPM_template.xlsx`
- Конфигурация заполнения в JSON: `templates/PPM_config.json`
- Программа открывает шаблон, заполняет ячейки данными, сохраняет новый файл

**Конфигурация (JSON):**
```json
{
  "month_cell": "C2",
  "version_cell": "C3",
  "table_start_row": 6,
  "columns": {
    "num": 0,
    "client": 1,
    "drawing": 2,
    "name": 3,
    "was": 4,
    "now": 5,
    "deadline": 6,
    "notes": 7
  },
  "signatures_row": 25
}
```

---

## 💾 ИМПОРТ/ЭКСПОРТ

### Импорт цен от снабженца

**Формат файла:** Excel (.xlsx) или JSON (.json)

**Структура Excel:**
```
┌────────────────────┬──────────┬────────────┐
│ Комплектующее      │ Цена     │ Дата       │
├────────────────────┼──────────┼────────────┤
│ Обечайка 126       │ 5000     │ 01.11.2025 │
│ Донышко 186        │ 3000     │ 01.11.2025 │
│ Патрубок 300 22 Р  │ 1500     │ 01.11.2025 │
└────────────────────┴──────────┴────────────┘
```

**Структура JSON:**
```json
[
  {
    "component": "Обечайка 126",
    "price": 5000,
    "date": "2025-11-01"
  },
  {
    "component": "Донышко 186",
    "price": 3000,
    "date": "2025-11-01"
  }
]
```

**Детали будут описаны в README** для программы снабженца (разработаем позже).

---

## 🔄 WORKFLOW (Как работает пользователь)

### Сценарий 1: Создание нового плана

1. Открыть программу → "ППМ" → "Создать план"
2. Выбрать месяц: Ноябрь 2025
3. Версия автоматически: 1
4. Добавить позиции:
   - Выбрать клиента (НТ)
   - Выбрать изделие (PB 35.126 R2-B15-НТ)
   - Количество: 100
   - Срок: 30.11.2025
   - Примечания: "Срочный заказ"
   - Нажать "Добавить"
5. Повторить для всех позиций (5-10 позиций обычно)
6. Сохранить план

### Сценарий 2: Создание изменения к плану

1. Открыть программу → "ППМ" → "Открыть план"
2. Выбрать: Ноябрь 2025, версия 1
3. Нажать "Создать изменение"
4. Система создаст версию 2 и скопирует все позиции
5. Редактировать позиции:
   - Изменить количество: 100 → 150
   - Изменить срок: 30.11 → 25.11
   - Добавить новую позицию
   - Удалить позицию
6. Сохранить изменение

### Сценарий 3: Просмотр отчета для снабженца

1. Открыть программу → "ППМ" → "Отчеты"
2. Выбрать "Потребность в материалах"
3. Выбрать план: Ноябрь 2025 (автоматически берется последняя версия)
4. Включить/выключить показ цен
5. Нажать "Экспорт в Excel"
6. Файл сохраняется в `reports/supply/Потребность_материалы_2025-11.xlsx`

### Сценарий 4: Экспорт ППМ для директора

1. Открыть программу → "ППМ" → "Отчеты"
2. Выбрать "План для подписи"
3. Выбрать план: Ноябрь 2025, версия 3
4. Нажать "Экспорт в Excel"
5. Файл сохраняется в `reports/plans/ППМ_Ноябрь_2025_v3.xlsx`
6. Директор открывает, подписывает, сканирует

---

## 🗂️ СТРУКТУРА ФАЙЛОВ ПРОЕКТА

```
ProductDB/
├── data/
│   ├── productdb.sqlite        # База данных
│   └── backups/                # Бэкапы БД
├── templates/
│   ├── PPM_template.xlsx       # Шаблон ППМ для директора
│   └── PPM_config.json         # Конфигурация заполнения шаблона
├── reports/
│   ├── supply/                 # Отчеты для снабженца
│   └── plans/                  # Экспортированные ППМ
├── schema.sql                  # Схема БД (включая ППМ)
├── database.py                 # CRUD для всех таблиц
├── logic.py                    # Бизнес-логика (существующая)
├── logic_ppm.py               # Бизнес-логика ППМ (новый)
├── export_ppm.py              # Экспорт отчетов (новый)
├── gui.py                     # Главное меню
├── gui_ppm.py                 # GUI для ППМ (новый)
├── main.py                    # Точка входа
├── DESIGN_PPM.md              # Этот документ
├── TODO.md                    # Список задач
└── README.md                  # Общее описание
```

---

## 🎯 СЛЕДУЮЩИЕ ШАГИ РАЗРАБОТКИ

См. файл **TODO.md**

---

## 📝 ПРИМЕЧАНИЯ

- Все расчеты делаются по последней версии плана (актуальной)
- История версий позволяет отследить как менялся план
- Бетон разных марок считается отдельно (важно!)
- Импорт цен планируется через отдельную программу для снабженца
- Excel шаблоны настраиваются через JSON конфигурацию

---

**Дата создания:** 28.10.2025
**Версия:** 1.0
**Статус:** Согласовано, готово к реализации
